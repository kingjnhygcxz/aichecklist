import React, { useState, useRef, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Separator } from '@/components/ui/separator';
// Lazy load components for better performance
const VideoPopup = React.lazy(() => import('@/components/ui/VideoPopup').then(module => ({ default: module.VideoPopup })));
import { User, Lock, Mic, Eye, EyeOff, Play, CheckCircle, Mail, Check, Star, Zap, Shield, Clock, Users, ChevronLeft, ChevronRight, Brain, BarChart3, Calendar } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { apiRequest } from '@/lib/queryClient';
import { useLocation } from 'wouter';
import { safeRedirect } from '@/lib/security';
// Lazy load download counter to reduce initial bundle size
const DownloadCounter = React.lazy(() => import('@/components/stats/DownloadCounter').then(module => ({ default: module.DownloadCounter })));
import { TermsOfService } from '@/components/legal/TermsOfService';
import { Checkbox } from '@/components/ui/checkbox';

export function Auth() {
  console.log("Auth component rendering");
  const [authMode, setAuthMode] = useState<'login' | 'register'>('login');
  
  // Horizontal scroll state
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const signupRef = useRef<HTMLDivElement>(null);
  const [currentSection, setCurrentSection] = useState(0);
  const sections = ['features', 'about', 'pricing'];
  
  const scrollToSection = (index: number) => {
    if (scrollContainerRef.current) {
      const container = scrollContainerRef.current;
      const sectionWidth = container.offsetWidth;
      container.scrollTo({
        left: sectionWidth * index,
        behavior: 'smooth'
      });
      setCurrentSection(index);
    }
  };
  
  const scrollToSignup = () => {
    signupRef.current?.scrollIntoView({ behavior: 'smooth' });
  };
  
  const handleHorizontalScroll = () => {
    if (scrollContainerRef.current) {
      const container = scrollContainerRef.current;
      const sectionWidth = container.offsetWidth;
      const newSection = Math.round(container.scrollLeft / sectionWidth);
      setCurrentSection(newSection);
    }
  };

  useEffect(() => {
    const container = scrollContainerRef.current;
    if (container) {
      container.addEventListener('scroll', handleHorizontalScroll);
      return () => container.removeEventListener('scroll', handleHorizontalScroll);
    }
  }, []);
  const [showPassword, setShowPassword] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [voiceAuthEnabled, setVoiceAuthEnabled] = useState(false);
  const [showVoiceTraining, setShowVoiceTraining] = useState(false);
  const [showVideoPopup, setShowVideoPopup] = useState(false);
  const [showTerms, setShowTerms] = useState(false);
  const [termsAccepted, setTermsAccepted] = useState(false);
  const [registrationSuccess, setRegistrationSuccess] = useState(false);
  const [registeredEmail, setRegisteredEmail] = useState('');
  const [rememberMe, setRememberMe] = useState(false);
  const { toast } = useToast();
  const [, setLocation] = useLocation();
  
  // Video URL for the demo video - using Streamable embed
  const videoUrl = "https://streamable.com/e/5b1sjj?loop=0";
  
  // Email code authentication state
  const [useEmailCode, setUseEmailCode] = useState(true); // Default to email code auth
  const [emailCodeStep, setEmailCodeStep] = useState<'email' | 'code'>('email');
  const [emailCodeSent, setEmailCodeSent] = useState(false);
  const [verificationCode, setVerificationCode] = useState('');

  // Form data
  const [formData, setFormData] = useState({
    username: '',
    email: '',
    password: '',
    confirmPassword: '',
    voicePassword: '',
    voiceTrainingData: '',
    firstName: '',
    lastName: ''
  });

  // Handle sending email code
  const handleSendEmailCode = async () => {
    if (!formData.email) {
      toast({
        title: "Email Required",
        description: "Please enter your email address",
        variant: "destructive",
      });
      return;
    }
    
    setIsLoading(true);
    try {
      const response = await apiRequest('POST', '/api/auth/send-code', { 
        email: formData.email 
      });
      
      if (response.ok) {
        const data = await response.json();
        toast({
          title: "Code Sent",
          description: "Check your email for the login code",
        });
        setEmailCodeSent(true);
        setEmailCodeStep('code');
      } else {
        const error = await response.json();
        toast({
          title: "Error",
          description: error.message || "Failed to send code",
          variant: "destructive",
        });
      }
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to send login code",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };
  
  // Handle verifying email code
  const handleVerifyCode = async () => {
    if (!verificationCode) {
      toast({
        title: "Code Required",
        description: "Please enter the verification code",
        variant: "destructive",
      });
      return;
    }
    
    setIsLoading(true);
    try {
      const response = await apiRequest('POST', '/api/auth/verify-code', {
        email: formData.email,
        code: verificationCode,
        username: formData.username || undefined
      });
      
      if (response.ok) {
        const userData = await response.json();
        
        // Store session
        if (userData.sessionId) {
          localStorage.setItem('sessionId', userData.sessionId);
          localStorage.setItem('userId', userData.id.toString());
          localStorage.setItem('username', userData.username);
        }
        
        toast({
          title: "Success",
          description: userData.message,
        });
        
        // Trigger auth check event
        window.dispatchEvent(new Event('userLoggedIn'));
        
        // Use client-side navigation instead of full reload
        setTimeout(() => {
          setLocation('/');
        }, 100);
      } else {
        const error = await response.json();
        toast({
          title: "Error",
          description: error.message || "Invalid code",
          variant: "destructive",
        });
      }
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to verify code",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  // Handle traditional login/register
  const handleTraditionalAuth = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    // For registration, validate passwords match and terms accepted
    if (authMode === 'register') {
      // Terms acceptance validation
      if (!termsAccepted) {
        toast({
          title: "Terms Required",
          description: "You must accept the Terms of Service to create an account",
          variant: "destructive",
        });
        setIsLoading(false);
        return;
      }
      
      // Password matching validation (only for registration)
      if (formData.password !== formData.confirmPassword) {
        toast({
          title: "Password Mismatch",
          description: "Passwords do not match. Please check and try again.",
          variant: "destructive",
        });
        setIsLoading(false);
        return;
      }
    }

    try {
      const endpoint = authMode === 'login' ? '/api/login' : '/api/register';
      // For registration, auto-generate username from email
      const autoUsername = formData.email.split('@')[0] + '_' + Math.random().toString(36).substring(2, 6);
      const payload = authMode === 'login' 
        ? { email: formData.email, password: formData.password, rememberMe }
        : { 
            username: autoUsername,
            email: formData.email, 
            password: formData.password, 
            firstName: formData.firstName,
            lastName: formData.lastName,
            voicePassword: formData.voicePassword,
            voiceEnabled: voiceAuthEnabled,
            termsAccepted: termsAccepted,
            termsVersion: 'v1.0'
          };

      const response = await apiRequest('POST', endpoint, payload);
      
      if (response.ok) {
        const userData = await response.json();
        
        // Handle email verification requirement for registration
        if (authMode === 'register' && userData.requiresVerification) {
          // Set success state to show prominent message
          setRegisteredEmail(userData.email);
          setRegistrationSuccess(true);
          toast({
            title: "Registration Successful!",
            description: `Please check your email (${userData.email}) and click the verification link to activate your account.`,
            variant: "default",
            duration: 10000, // Show for 10 seconds
          });
          // Don't redirect - user needs to verify email first
        } else if (authMode === 'register') {
          // Registration without email or legacy flow
          toast({
            title: "Registration Successful!",
            description: "Welcome to AICHECKLIST! You are now logged in.",
            variant: "default",
          });
          
          // Store session token if provided
          if (userData.sessionId) {
            localStorage.setItem('sessionId', userData.sessionId);
            // Dispatch custom event to notify auth system
            window.dispatchEvent(new Event('userLoggedIn'));
          }
          
          // Force a small delay to ensure localStorage is set before redirect
          setTimeout(() => {
            setLocation('/');
          }, 200);
        } else {
          // Login successful
          if (userData.sessionId) {
            localStorage.setItem('sessionId', userData.sessionId);
            // Dispatch custom event to notify auth system
            window.dispatchEvent(new Event('userLoggedIn'));
          }
          
          // Force a small delay to ensure localStorage is set before redirect
          setTimeout(() => {
            setLocation('/');
          }, 200);
        }
      } else {
        const errorData = await response.json();
        
        // Handle email verification required error
        if (errorData.requiresVerification) {
          toast({
            title: "Email Verification Required",
            description: errorData.message || "Please verify your email address before logging in.",
            variant: "destructive",
          });
          setIsLoading(false);
          return;
        }
        
        throw new Error(errorData.message || 'Authentication failed');
      }
    } catch (error) {
      toast({
        title: "Error",
        description: error instanceof Error ? error.message : "Authentication failed",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  // Handle voice biometric login
  const handleVoiceBiometricLogin = async (voiceData: string, transcribedText?: string) => {
    console.log('handleVoiceBiometricLogin called with voiceData length:', voiceData?.length);
    console.log('Transcribed text:', transcribedText);
    console.log('Current formData.username:', formData.username);
    
    // Get username from input field directly if form state is empty
    const usernameInput = document.getElementById('username') as HTMLInputElement;
    const username = formData.username.trim() || usernameInput?.value?.trim() || '';
    
    console.log('Final username to use:', username);
    
    if (!username) {
      console.log('Username validation failed - field is empty');
      toast({
        title: "Username Required",
        description: "Please enter your username first",
        variant: "destructive",
      });
      return;
    }

    setIsLoading(true);
    console.log('Attempting voice biometric login for:', username);

    try {
      const response = await apiRequest('POST', '/api/voice-biometric-login', {
        username: username,
        voiceData: voiceData,
        transcribedText: transcribedText
      });

      if (response.ok) {
        const userData = await response.json();
        console.log('Voice biometric login successful:', userData);
        
        // Store session token if provided
        if (userData.sessionId) {
          localStorage.setItem('sessionId', userData.sessionId);
        }
        
        toast({
          title: "Voice Authentication Successful",
          description: "Welcome back!",
        });
        
        // Force navigation to home page
        setTimeout(() => {
          safeRedirect('/');
        }, 500);
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.log('Voice biometric login failed:', errorData);
        console.log('Error message received:', errorData.message);
        
        // If voice authentication is not set up, offer to set it up
        if (errorData.message === "Voice authentication not set up") {
          console.log('Voice not set up, triggering auto-setup...');
          setIsLoading(false); // Reset loading state
          toast({
            title: "Voice Setup Required",
            description: "Setting up voice authentication for your account...",
          });
          await handleVoiceBiometricSetup(voiceData);
          return;
        }
        
        throw new Error(errorData.message || 'Voice authentication failed');
      }
    } catch (error: any) {
      console.error('Voice biometric login error:', error);
      
      // Check if this is a 401 error for voice setup
      if (error.message && error.message.includes("Voice authentication not set up")) {
        console.log('Caught voice setup error, triggering auto-setup...');
        setIsLoading(false);
        toast({
          title: "Voice Setup Required",
          description: "Setting up voice authentication for your account...",
        });
        await handleVoiceBiometricSetup(voiceData);
        return;
      }
      
      toast({
        title: "Voice Authentication Failed",
        description: error instanceof Error ? error.message : "Voice not recognized. Please try again.",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  // Handle voice biometric setup
  const handleVoiceBiometricSetup = async (voiceData: string) => {
    // Get username from input field directly if form state is empty
    const usernameInput = document.getElementById('username') as HTMLInputElement;
    const username = formData.username.trim() || usernameInput?.value?.trim() || '';
    
    console.log('Setting up voice biometric for username:', username);
    console.log('Voice data length for setup:', voiceData?.length);
    
    try {
      const response = await apiRequest('POST', '/api/voice-biometric-setup', {
        username: username,
        voiceData: voiceData
      });

      if (response.ok) {
        toast({
          title: "Voice Authentication Setup Complete",
          description: "You can now log in with your voice",
        });
        // Automatically attempt login after setup
        await handleVoiceBiometricLogin(voiceData);
      } else {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || 'Voice setup failed');
      }
    } catch (error) {
      console.error('Voice biometric setup error:', error);
      toast({
        title: "Voice Setup Failed",
        description: error instanceof Error ? error.message : "Could not set up voice authentication",
        variant: "destructive",
      });
    }
  };

  // Handle voice password setup during registration
  const handleVoicePasswordSetup = (voicePassword: string) => {
    setFormData(prev => ({ ...prev, voicePassword }));
    setVoiceAuthEnabled(true);
    toast({
      title: "Voice Password Set",
      description: "Your voice password has been recorded successfully.",
    });
  };

  // Handle voice training completion
  const handleVoiceTrainingComplete = (voiceData: any) => {
    setFormData(prev => ({ 
      ...prev, 
      voicePassword: "welcome to the best ai list",
      voiceTrainingData: JSON.stringify(voiceData)
    }));
    setVoiceAuthEnabled(true);
    setShowVoiceTraining(false);
    toast({
      title: "Voice Training Complete",
      description: "Your voice has been trained successfully!",
    });
  };

  return (
    <div className="auth-container min-h-screen bg-gradient-to-br from-gray-900 to-gray-800 flex flex-col overflow-y-auto">
      {/* Navigation Header */}
      <nav className="sticky top-0 z-50 bg-gray-900/95 backdrop-blur-sm border-b border-gray-700" data-testid="nav-header">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-14">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                <Check className="h-5 w-5 text-white" />
              </div>
              <span className="text-xl font-bold text-white">AIChecklist</span>
            </div>
            
            <div className="hidden md:flex items-center gap-6">
              <button 
                onClick={() => scrollToSection(0)}
                className={`text-sm font-medium transition-colors duration-150 ${currentSection === 0 ? 'text-blue-400' : 'text-gray-300 hover:text-white'}`}
                data-testid="nav-features"
              >
                Features
              </button>
              <button 
                onClick={() => scrollToSection(1)}
                className={`text-sm font-medium transition-colors duration-150 ${currentSection === 1 ? 'text-blue-400' : 'text-gray-300 hover:text-white'}`}
                data-testid="nav-about"
              >
                About Us
              </button>
              <button 
                onClick={() => scrollToSection(2)}
                className={`text-sm font-medium transition-colors duration-150 ${currentSection === 2 ? 'text-blue-400' : 'text-gray-300 hover:text-white'}`}
                data-testid="nav-pricing"
              >
                Pricing
              </button>
            </div>
            
            <Button 
              onClick={scrollToSignup}
              className="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 h-9"
              data-testid="nav-signup-btn"
            >
              Sign Up
            </Button>
          </div>
        </div>
      </nav>

      {/* Horizontal Scrolling Sections with Arrow Navigation */}
      <div className="relative">
        {/* Left Arrow */}
        <button
          onClick={() => scrollToSection(Math.max(0, currentSection - 1))}
          className={`absolute left-2 md:left-4 top-1/2 -translate-y-1/2 z-20 p-2 md:p-3 rounded-full bg-gray-800/80 border border-gray-600 hover:bg-gray-700 hover:border-primary transition-all duration-200 ${currentSection === 0 ? 'opacity-30 cursor-not-allowed' : 'opacity-100'}`}
          disabled={currentSection === 0}
          data-testid="scroll-arrow-left"
        >
          <ChevronLeft className="h-5 w-5 md:h-6 md:w-6 text-white" />
        </button>
        
        {/* Right Arrow */}
        <button
          onClick={() => scrollToSection(Math.min(sections.length - 1, currentSection + 1))}
          className={`absolute right-2 md:right-4 top-1/2 -translate-y-1/2 z-20 p-2 md:p-3 rounded-full bg-gray-800/80 border border-gray-600 hover:bg-gray-700 hover:border-primary transition-all duration-200 ${currentSection === sections.length - 1 ? 'opacity-30 cursor-not-allowed' : 'opacity-100'}`}
          disabled={currentSection === sections.length - 1}
          data-testid="scroll-arrow-right"
        >
          <ChevronRight className="h-5 w-5 md:h-6 md:w-6 text-white" />
        </button>
      <div 
        ref={scrollContainerRef}
        className="flex overflow-x-auto snap-x snap-mandatory"
        style={{ 
          scrollbarWidth: 'none', 
          msOverflowStyle: 'none',
          WebkitOverflowScrolling: 'touch',
          scrollBehavior: 'smooth'
        }}
        data-testid="horizontal-scroll-container"
      >
        {/* Features Section */}
        <section className="min-w-full snap-start flex items-center justify-center py-12 px-6" data-testid="section-features">
          <div className="max-w-5xl mx-auto w-full">
            <div className="text-center mb-8">
              <h2 className="text-3xl md:text-4xl font-bold text-white mb-3">Powerful Features</h2>
              <p className="text-lg text-gray-300">Everything you need to manage tasks intelligently</p>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {[
                { icon: Mic, title: 'Voice Commands', desc: 'Control tasks hands-free' },
                { icon: Brain, title: 'AI Suggestions', desc: 'Smart recommendations' },
                { icon: BarChart3, title: 'Analytics', desc: 'Track productivity' },
                { icon: Calendar, title: 'Scheduling', desc: 'Calendar integration' },
                { icon: Shield, title: 'Secure', desc: 'Enterprise security' },
                { icon: Clock, title: 'Time Tracking', desc: 'Built-in timer' },
                { icon: Users, title: 'Collaboration', desc: 'Share tasks' },
                { icon: Zap, title: 'Fast Sync', desc: 'Real-time sync' },
              ].map((feature) => (
                <div key={feature.title} className="bg-gray-800/50 border border-gray-700 rounded-lg p-4 hover:border-blue-500/50 transition-colors duration-150">
                  <feature.icon className="h-8 w-8 text-blue-400 mb-2" />
                  <h3 className="text-sm font-semibold text-white mb-1">{feature.title}</h3>
                  <p className="text-gray-400 text-xs">{feature.desc}</p>
                </div>
              ))}
            </div>
          </div>
        </section>

        {/* About Section */}
        <section className="min-w-full snap-start flex items-center justify-center py-12 px-6" data-testid="section-about">
          <div className="max-w-3xl mx-auto text-center">
            <h2 className="text-3xl md:text-4xl font-bold text-white mb-4">About AIChecklist</h2>
            <p className="text-lg text-gray-300 mb-6 leading-relaxed">
              We believe in making productivity accessible to everyone. AIChecklist combines 
              cutting-edge AI technology with intuitive design.
            </p>
            <div className="grid grid-cols-3 gap-6 mb-8">
              <div><div className="text-3xl font-bold text-blue-400">50K+</div><div className="text-gray-400 text-sm">Users</div></div>
              <div><div className="text-3xl font-bold text-purple-400">1M+</div><div className="text-gray-400 text-sm">Tasks</div></div>
              <div><div className="text-3xl font-bold text-green-400">99.9%</div><div className="text-gray-400 text-sm">Uptime</div></div>
            </div>
            <div className="p-6 bg-gray-800/50 rounded-xl border border-gray-700">
              <h3 className="text-xl font-semibold text-white mb-2">Our Mission</h3>
              <p className="text-gray-300 text-sm">Empower individuals and teams through intelligent task management powered by AI.</p>
            </div>
          </div>
        </section>

        {/* Pricing Section */}
        <section className="min-w-full snap-start flex items-center justify-center py-12 px-6" data-testid="section-pricing">
          <div className="max-w-4xl mx-auto">
            <div className="text-center mb-8">
              <h2 className="text-3xl md:text-4xl font-bold text-white mb-3">Simple Pricing</h2>
              <p className="text-lg text-gray-300">Start free, upgrade when you need more</p>
            </div>
            <div className="grid md:grid-cols-3 gap-6">
              <div className="bg-gray-800/50 border border-gray-700 rounded-xl p-5">
                <h3 className="text-white font-semibold text-lg">Free</h3>
                <div className="text-3xl font-bold text-white my-3">$0<span className="text-sm text-gray-400">/mo</span></div>
                <ul className="space-y-2 text-sm text-gray-300">
                  {['Up to 50 tasks', 'Basic AI', 'Voice commands'].map(f => <li key={f} className="flex items-center gap-2"><Check className="h-4 w-4 text-green-400" />{f}</li>)}
                </ul>
                <Button onClick={scrollToSignup} variant="outline" className="w-full mt-4 border-gray-600" data-testid="btn-free">Get Started</Button>
              </div>
              <div className="bg-gradient-to-b from-blue-900/50 to-purple-900/50 border-2 border-blue-500 rounded-xl p-5 relative">
                <span className="absolute -top-2.5 left-1/2 -translate-x-1/2 bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full">POPULAR</span>
                <h3 className="text-white font-semibold text-lg">Pro</h3>
                <div className="text-3xl font-bold text-white my-3">$9<span className="text-sm text-gray-400">/mo</span></div>
                <ul className="space-y-2 text-sm text-gray-200">
                  {['Unlimited tasks', 'Advanced AI', 'Team collab', 'Analytics'].map(f => <li key={f} className="flex items-center gap-2"><Check className="h-4 w-4 text-blue-400" />{f}</li>)}
                </ul>
                <Button onClick={scrollToSignup} className="w-full mt-4 bg-gradient-to-r from-blue-600 to-purple-600" data-testid="btn-pro">Start Trial</Button>
              </div>
              <div className="bg-gray-800/50 border border-gray-700 rounded-xl p-5">
                <h3 className="text-white font-semibold text-lg">Enterprise</h3>
                <div className="text-3xl font-bold text-white my-3">Custom</div>
                <ul className="space-y-2 text-sm text-gray-300">
                  {['Everything in Pro', 'SSO', 'Dedicated support'].map(f => <li key={f} className="flex items-center gap-2"><Check className="h-4 w-4 text-green-400" />{f}</li>)}
                </ul>
                <Button onClick={scrollToSignup} variant="outline" className="w-full mt-4 border-gray-600" data-testid="btn-enterprise">Contact</Button>
              </div>
            </div>
          </div>
        </section>
      </div>
      </div>

      {/* Section Indicators */}
      <div className="flex justify-center gap-2 py-3 bg-gray-900/50" data-testid="section-indicators">
        {sections.map((section, index) => (
          <button
            key={section}
            onClick={() => scrollToSection(index)}
            className={`h-2 rounded-full transition-all duration-150 ${
              currentSection === index ? 'bg-blue-500 w-6' : 'bg-gray-600 w-2 hover:bg-gray-500'
            }`}
            data-testid={`indicator-${section}`}
          />
        ))}
      </div>

      {/* Maintenance Notice Banner */}
      <div className="bg-amber-500 text-white py-2 px-4 text-center font-medium w-full" data-testid="banner-maintenance">
        <span className="inline-flex items-center gap-2 text-sm">
          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          Doing maintenance - Thank you for your patience
        </span>
      </div>
      
      {/* Login/Signup Section */}
      <div ref={signupRef} className="flex-1 flex items-start lg:items-center justify-center p-4">
      <div className="w-full max-w-6xl grid lg:grid-cols-2 gap-8 py-8 pb-16">
        
        {/* Hero Section - Hidden on mobile to prevent overlap */}
        <motion.div 
          initial={{ opacity: 0, x: -50 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.6 }}
          className="hidden lg:flex flex-col justify-center space-y-6 text-center lg:text-left"
        >
          <div>
            <h1 className="text-4xl lg:text-6xl font-bold text-white">
              AICHECKLIST
            </h1>
            <p className="text-xl text-gray-300 mt-4">
              Intelligent task management with voice-powered authentication
            </p>
          </div>
          
          <div className="space-y-4">
            <div className="flex items-center gap-3">
              <div className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                <Mic className="h-4 w-4 text-primary" />
              </div>
              <span className="text-white">Voice commands for tasks (coming soon: voice login)</span>
            </div>
            <div className="flex items-center gap-3">
              <div className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                <User className="h-4 w-4 text-primary" />
              </div>
              <span className="text-white">AI-powered task suggestions</span>
            </div>
            <div className="flex items-center gap-3">
              <div className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                <Lock className="h-4 w-4 text-primary" />
              </div>
              <span className="text-white">Secure cloud synchronization</span>
            </div>
            
            {/* Video Introduction Button */}
            <div className="flex items-center gap-3 mt-4">
              <button
                onClick={() => setShowVideoPopup(true)}
                className="relative text-green-600 hover:text-green-700 underline hover:no-underline transition-all duration-200 text-left overflow-hidden light-wave-text"
              >
                Here is why to use AI Checklist
              </button>
            </div>
            
            {/* Video Demo Button */}
            <div className="flex justify-center lg:justify-start mt-6">
              <Button
                onClick={() => setShowVideoPopup(true)}
                variant="outline"
                className="group flex items-center gap-2 border-primary/50 hover:border-primary hover:bg-primary/10"
              >
                <Play className="h-4 w-4 text-primary group-hover:animate-pulse" />
                Watch Demo Video
              </Button>
            </div>
            
            {/* Download Counter - Under the video button */}
            <div className="flex justify-center lg:justify-start mt-4">
              <React.Suspense fallback={<div className="text-sm text-muted-foreground">Loading stats...</div>}>
                <DownloadCounter />
              </React.Suspense>
            </div>
          </div>
        </motion.div>
        
        {/* Mobile Header - Shown only on mobile */}
        <div className="lg:hidden text-center mb-4">
          <h1 className="text-3xl font-bold text-white">AICHECKLIST</h1>
          <p className="text-sm text-gray-300 mt-2">Intelligent task management</p>
        </div>

        {/* Auth Form Section */}
        <motion.div
          initial={{ opacity: 0, x: 50 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.6, delay: 0.2 }}
        >
          <Card className="w-full max-w-md mx-auto">
            <CardHeader className="text-center">
              <CardTitle className="text-2xl">
                {authMode === 'login' ? 'Welcome Back' : 'Create Account'}
              </CardTitle>
              <CardDescription>
                {authMode === 'login' 
                  ? 'Sign in to your account'
                  : 'Create a new account'
                }
              </CardDescription>
            </CardHeader>

            <CardContent>
              <Tabs value={authMode} onValueChange={(value) => setAuthMode(value as 'login' | 'register')}>
                <TabsList className="grid w-full grid-cols-2">
                  <TabsTrigger value="login">Login</TabsTrigger>
                  <TabsTrigger value="register">Register</TabsTrigger>
                </TabsList>

                <TabsContent value="login" className="space-y-4">
                  {/* Choose between email code or username/password login */}
                  {useEmailCode ? (
                    <motion.div
                      key="email-code-login"
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="space-y-4"
                    >
                      <div className="text-center space-y-2">
                        <h3 className="text-lg font-semibold">Sign in with Email</h3>
                        <p className="text-sm text-muted-foreground">
                          No password needed - we'll send you a login code
                        </p>
                      </div>
                      
                      {emailCodeStep === 'email' ? (
                        <>
                          <div className="space-y-2">
                            <Label htmlFor="email-login">Email Address</Label>
                            <Input
                              id="email-login"
                              type="email"
                              value={formData.email}
                              onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                              placeholder="your.email@example.com"
                              required
                            />
                          </div>
                          
                          <Button 
                            onClick={handleSendEmailCode} 
                            className="w-full" 
                            disabled={isLoading}
                            type="button"
                          >
                            {isLoading ? 'Sending Code...' : 'Send Login Code'}
                          </Button>
                        </>
                      ) : (
                        <>
                          <div className="space-y-2">
                            <Label htmlFor="code">Enter Code</Label>
                            <p className="text-sm text-muted-foreground">
                              We sent a 6-digit code to {formData.email}
                            </p>
                            <Input
                              id="code"
                              type="text"
                              value={verificationCode}
                              onChange={(e) => setVerificationCode(e.target.value)}
                              placeholder="Enter 6-digit code"
                              maxLength={6}
                              className="text-center text-2xl tracking-widest font-mono"
                              required
                            />
                          </div>
                          
                          <Button 
                            onClick={handleVerifyCode} 
                            className="w-full" 
                            disabled={isLoading}
                            type="button"
                          >
                            {isLoading ? 'Verifying...' : 'Sign In'}
                          </Button>
                          
                          <button
                            type="button"
                            onClick={() => {
                              setEmailCodeStep('email');
                              setVerificationCode('');
                            }}
                            className="text-sm text-muted-foreground hover:text-primary underline w-full text-center"
                          >
                            Use a different email
                          </button>
                        </>
                      )}
                      
                      <Separator />
                      
                      <button
                        type="button"
                        onClick={() => {
                          setUseEmailCode(false);
                          setEmailCodeStep('email');
                          setVerificationCode('');
                        }}
                        className="text-sm text-muted-foreground hover:text-primary underline w-full text-center"
                      >
                        Sign in with email & password instead
                      </button>
                      
                      <div className="text-center mt-4">
                        <p className="text-sm text-muted-foreground">
                          AIChecklist.io™
                        </p>
                      </div>
                    </motion.div>
                  ) : (
                    <motion.form
                      key="traditional-login"
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      onSubmit={handleTraditionalAuth}
                      className="space-y-4"
                    >
                    <div className="space-y-2">
                      <Label htmlFor="login-email-pw">Email</Label>
                      <Input
                        id="login-email-pw"
                        type="email"
                        value={formData.email}
                        onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                        placeholder="Enter your email"
                        required
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="password">Password</Label>
                      <div className="relative">
                        <Input
                          id="password"
                          type={showPassword ? 'text' : 'password'}
                          value={formData.password}
                          onChange={(e) => setFormData(prev => ({ ...prev, password: e.target.value }))}
                          required
                        />
                        <Button
                          type="button"
                          variant="ghost"
                          size="icon"
                          className="absolute right-0 top-0 h-full px-3"
                          onClick={() => setShowPassword(!showPassword)}
                        >
                          {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </Button>
                      </div>
                    </div>

                    <div className="flex items-center justify-between">
                      <div className="flex items-center space-x-2">
                        <Checkbox
                          id="remember-me"
                          checked={rememberMe}
                          onCheckedChange={(checked) => setRememberMe(checked === true)}
                          data-testid="checkbox-remember-me"
                        />
                        <Label 
                          htmlFor="remember-me" 
                          className="text-sm font-normal cursor-pointer"
                        >
                          Remember me for 30 days
                        </Label>
                      </div>
                      <button
                        type="button"
                        onClick={() => setLocation('/forgot-password')}
                        className="text-sm text-muted-foreground hover:text-primary underline"
                      >
                        Forgot Password?
                      </button>
                    </div>

                    <Button type="submit" className="w-full" disabled={isLoading}>
                      {isLoading ? 'Signing In...' : 'Sign In'}
                    </Button>
                    
                    <Separator />
                    
                    <button
                      type="button"
                      onClick={() => {
                        setUseEmailCode(true);
                        setEmailCodeStep('email');
                      }}
                      className="text-sm text-muted-foreground hover:text-primary underline w-full text-center"
                    >
                      Sign in with email code instead (no password needed)
                    </button>
                    
                    <div className="text-center mt-4">
                      <p className="text-sm text-muted-foreground">
                        AIChecklist.io™
                      </p>
                    </div>
                  </motion.form>
                  )}
                </TabsContent>

                <TabsContent value="register" className="space-y-4">
                  {registrationSuccess ? (
                    <motion.div
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="text-center space-y-6 py-8"
                      data-testid="registration-success"
                    >
                      <div className="flex justify-center">
                        <div className="h-20 w-20 rounded-full bg-green-100 flex items-center justify-center">
                          <CheckCircle className="h-10 w-10 text-green-600" />
                        </div>
                      </div>
                      
                      <div className="space-y-2">
                        <h3 className="text-xl font-semibold text-green-700">Registration Successful!</h3>
                        <p className="text-muted-foreground">
                          We've sent a verification email to:
                        </p>
                        <p className="font-medium flex items-center justify-center gap-2">
                          <Mail className="h-4 w-4" />
                          {registeredEmail}
                        </p>
                      </div>
                      
                      <div className="bg-muted/50 rounded-lg p-4 text-sm text-muted-foreground">
                        <p>Please check your inbox and click the verification link to activate your account.</p>
                        <p className="mt-2">Don't see the email? Check your spam folder.</p>
                      </div>
                      
                      <Button
                        variant="outline"
                        onClick={() => {
                          setRegistrationSuccess(false);
                          setAuthMode('login');
                        }}
                        data-testid="button-back-to-login"
                      >
                        Back to Login
                      </Button>
                    </motion.div>
                  ) : (
                  <form onSubmit={handleTraditionalAuth} className="space-y-4">
                    <div className="grid grid-cols-2 gap-3">
                      <div className="space-y-2">
                        <Label htmlFor="reg-firstname">First Name *</Label>
                        <Input
                          id="reg-firstname"
                          type="text"
                          value={formData.firstName}
                          onChange={(e) => setFormData(prev => ({ ...prev, firstName: e.target.value }))}
                          placeholder="Frederick"
                          required
                          data-testid="input-firstname"
                        />
                      </div>
                      <div className="space-y-2">
                        <Label htmlFor="reg-lastname">Last Name *</Label>
                        <Input
                          id="reg-lastname"
                          type="text"
                          value={formData.lastName}
                          onChange={(e) => setFormData(prev => ({ ...prev, lastName: e.target.value }))}
                          placeholder="Last name"
                          required
                          data-testid="input-lastname"
                        />
                      </div>
                    </div>
                    
                    <div className="space-y-2">
                      <Label htmlFor="reg-email">Email Address *</Label>
                      <Input
                        id="reg-email"
                        type="email"
                        value={formData.email}
                        onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                        placeholder="your.email@example.com"
                        required
                        data-testid="input-email"
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="reg-password">Password</Label>
                      <div className="relative">
                        <Input
                          id="reg-password"
                          type={showPassword ? 'text' : 'password'}
                          value={formData.password}
                          onChange={(e) => setFormData(prev => ({ ...prev, password: e.target.value }))}
                          required
                        />
                        <Button
                          type="button"
                          variant="ghost"
                          size="icon"
                          className="absolute right-0 top-0 h-full px-3"
                          onClick={() => setShowPassword(!showPassword)}
                        >
                          {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </Button>
                      </div>
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="reg-confirm-password">Confirm Password</Label>
                      <div className="relative">
                        <Input
                          id="reg-confirm-password"
                          type={showPassword ? 'text' : 'password'}
                          value={formData.confirmPassword}
                          onChange={(e) => setFormData(prev => ({ ...prev, confirmPassword: e.target.value }))}
                          required
                          className={formData.password && formData.confirmPassword && formData.password !== formData.confirmPassword ? 'border-red-500' : ''}
                        />
                        <Button
                          type="button"
                          variant="ghost"
                          size="icon"
                          className="absolute right-0 top-0 h-full px-3"
                          onClick={() => setShowPassword(!showPassword)}
                        >
                          {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </Button>
                      </div>
                      {formData.password && formData.confirmPassword && formData.password !== formData.confirmPassword && (
                        <p className="text-sm text-red-500">
                          Passwords do not match
                        </p>
                      )}
                    </div>


                    {/* Terms of Service Agreement */}
                    <div className="space-y-3 p-4 border rounded-lg bg-blue-50 border-blue-200">
                      <div className="flex items-start space-x-3">
                        <Checkbox
                          id="terms-checkbox"
                          checked={termsAccepted}
                          onCheckedChange={(checked) => setTermsAccepted(checked as boolean)}
                          data-testid="terms-checkbox"
                          className="mt-0.5"
                        />
                        <div className="space-y-2">
                          <Label htmlFor="terms-checkbox" className="text-sm font-medium leading-5">
                            I accept the{' '}
                            <button
                              type="button"
                              onClick={() => setShowTerms(true)}
                              className="text-blue-600 hover:text-blue-800 underline"
                            >
                              Terms of Service and License Agreement
                            </button>
                          </Label>
                          <p className="text-xs text-blue-700">
                            Required: Includes competitive use restrictions
                          </p>
                        </div>
                      </div>
                    </div>

                    <Separator />

                    <div className="space-y-4 opacity-50">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <Label className="text-muted-foreground">Voice Password</Label>
                          <span className="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">Coming Soon</span>
                        </div>
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          disabled
                          className="cursor-not-allowed"
                        >
                          Enable
                        </Button>
                      </div>
                      <p className="text-xs text-muted-foreground">
                        Voice biometric authentication will be available in a future update.
                      </p>
                    </div>

                    <Button type="submit" className="w-full text-white" disabled={isLoading}>
                      {isLoading ? 'Creating Account...' : 'Create Account'}
                    </Button>
                    
                    <div className="text-center mt-4">
                      <p className="text-sm text-muted-foreground">
                        AIChecklist.io™
                      </p>
                    </div>
                  </form>
                  )}
                </TabsContent>
              </Tabs>
            </CardContent>
          </Card>
          
          {/* Mobile Video Button - Below the login card */}
          <div className="lg:hidden text-center mt-4">
            <Button
              onClick={() => setShowVideoPopup(true)}
              variant="outline"
              size="sm"
              className="group flex items-center gap-2 mx-auto border-primary/50 hover:border-primary hover:bg-primary/10"
            >
              <Play className="h-4 w-4 text-primary group-hover:animate-pulse" />
              Watch Demo Video
            </Button>
          </div>
        </motion.div>
      </div>
      </div>
      
      {/* Terms of Service Modal */}
      <TermsOfService
        isOpen={showTerms}
        onClose={() => setShowTerms(false)}
        onAccept={() => {
          setTermsAccepted(true);
          setShowTerms(false);
          toast({
            title: "Terms Accepted",
            description: "Thank you for accepting our Terms of Service",
            variant: "default",
          });
        }}
      />

      {/* Video Popup - Only load when opened */}
      {showVideoPopup && (
        <React.Suspense fallback={<div className="fixed inset-0 bg-black/50 flex items-center justify-center text-white">Loading video...</div>}>
          <VideoPopup
            isOpen={showVideoPopup}
            onClose={() => setShowVideoPopup(false)}
            videoUrl={videoUrl}
            title="Why AI Checklist?"
          />
        </React.Suspense>
      )}
    </div>
  );
}