import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Separator } from '@/components/ui/separator';
// Lazy load components for better performance
const VideoPopup = React.lazy(() => import('@/components/ui/VideoPopup').then(module => ({ default: module.VideoPopup })));
import { User, Lock, Mic, Eye, EyeOff, Play } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { apiRequest } from '@/lib/queryClient';
import { useLocation } from 'wouter';
import { safeRedirect } from '@/lib/security';
// Lazy load download counter to reduce initial bundle size
const DownloadCounter = React.lazy(() => import('@/components/stats/DownloadCounter').then(module => ({ default: module.DownloadCounter })));
import { TermsOfService } from '@/components/legal/TermsOfService';
import { Checkbox } from '@/components/ui/checkbox';

export function Auth() {
  console.log("Auth component rendering");
  const [authMode, setAuthMode] = useState<'login' | 'register'>('login');
  const [showPassword, setShowPassword] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [voiceAuthEnabled, setVoiceAuthEnabled] = useState(false);
  const [showVoiceTraining, setShowVoiceTraining] = useState(false);
  const [showVideoPopup, setShowVideoPopup] = useState(false);
  const [showTerms, setShowTerms] = useState(false);
  const [termsAccepted, setTermsAccepted] = useState(false);
  const { toast } = useToast();
  const [, setLocation] = useLocation();
  
  // Video URL for the demo video - using Streamable embed
  const videoUrl = "https://streamable.com/e/khw7c6?autoplay=1&loop=0";
  
  // Email code authentication state
  const [useEmailCode, setUseEmailCode] = useState(true); // Default to email code auth
  const [emailCodeStep, setEmailCodeStep] = useState<'email' | 'code'>('email');
  const [emailCodeSent, setEmailCodeSent] = useState(false);
  const [verificationCode, setVerificationCode] = useState('');

  // Form data
  const [formData, setFormData] = useState({
    username: '',
    email: '',
    password: '',
    confirmPassword: '',
    voicePassword: '',
    voiceTrainingData: ''
  });

  // Handle sending email code
  const handleSendEmailCode = async () => {
    if (!formData.email) {
      toast({
        title: "Email Required",
        description: "Please enter your email address",
        variant: "destructive",
      });
      return;
    }
    
    setIsLoading(true);
    try {
      const response = await apiRequest('POST', '/api/auth/send-code', { 
        email: formData.email 
      });
      
      if (response.ok) {
        const data = await response.json();
        toast({
          title: "Code Sent",
          description: "Check your email for the login code",
        });
        setEmailCodeSent(true);
        setEmailCodeStep('code');
      } else {
        const error = await response.json();
        toast({
          title: "Error",
          description: error.message || "Failed to send code",
          variant: "destructive",
        });
      }
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to send login code",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };
  
  // Handle verifying email code
  const handleVerifyCode = async () => {
    if (!verificationCode) {
      toast({
        title: "Code Required",
        description: "Please enter the verification code",
        variant: "destructive",
      });
      return;
    }
    
    setIsLoading(true);
    try {
      const response = await apiRequest('POST', '/api/auth/verify-code', {
        email: formData.email,
        code: verificationCode,
        username: formData.username || undefined
      });
      
      if (response.ok) {
        const userData = await response.json();
        
        // Store session
        if (userData.sessionId) {
          localStorage.setItem('sessionId', userData.sessionId);
          localStorage.setItem('userId', userData.id.toString());
          localStorage.setItem('username', userData.username);
        }
        
        toast({
          title: "Success",
          description: userData.message,
        });
        
        // Trigger auth check event
        window.dispatchEvent(new Event('userLoggedIn'));
        
        // Use client-side navigation instead of full reload
        setTimeout(() => {
          setLocation('/');
        }, 100);
      } else {
        const error = await response.json();
        toast({
          title: "Error",
          description: error.message || "Invalid code",
          variant: "destructive",
        });
      }
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to verify code",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  // Handle traditional login/register
  const handleTraditionalAuth = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    // For registration, validate passwords match and terms accepted
    if (authMode === 'register') {
      // Terms acceptance validation
      if (!termsAccepted) {
        toast({
          title: "Terms Required",
          description: "You must accept the Terms of Service to create an account",
          variant: "destructive",
        });
        setIsLoading(false);
        return;
      }
      
      // Password matching validation (only for registration)
      if (formData.password !== formData.confirmPassword) {
        toast({
          title: "Password Mismatch",
          description: "Passwords do not match. Please check and try again.",
          variant: "destructive",
        });
        setIsLoading(false);
        return;
      }
    }

    try {
      const endpoint = authMode === 'login' ? '/api/login' : '/api/register';
      const payload = authMode === 'login' 
        ? { username: formData.username, password: formData.password }
        : { 
            username: formData.username,
            email: formData.email, 
            password: formData.password, 
            voicePassword: formData.voicePassword,
            voiceEnabled: voiceAuthEnabled,
            termsAccepted: termsAccepted,
            termsVersion: 'v1.0'
          };

      const response = await apiRequest('POST', endpoint, payload);
      
      if (response.ok) {
        const userData = await response.json();
        
        // Handle email verification requirement for registration
        if (authMode === 'register' && userData.requiresVerification) {
          toast({
            title: "Registration Successful!",
            description: `Please check your email (${userData.email}) and click the verification link to activate your account.`,
            variant: "default",
          });
          // Don't redirect - user needs to verify email first
        } else if (authMode === 'register') {
          // Registration without email or legacy flow
          toast({
            title: "Registration Successful!",
            description: "Welcome to AICHECKLIST! You are now logged in.",
            variant: "default",
          });
          
          // Store session token if provided
          if (userData.sessionId) {
            localStorage.setItem('sessionId', userData.sessionId);
            // Dispatch custom event to notify auth system
            window.dispatchEvent(new Event('userLoggedIn'));
          }
          
          // Force a small delay to ensure localStorage is set before redirect
          setTimeout(() => {
            setLocation('/');
          }, 200);
        } else {
          // Login successful
          if (userData.sessionId) {
            localStorage.setItem('sessionId', userData.sessionId);
            // Dispatch custom event to notify auth system
            window.dispatchEvent(new Event('userLoggedIn'));
          }
          
          // Force a small delay to ensure localStorage is set before redirect
          setTimeout(() => {
            setLocation('/');
          }, 200);
        }
      } else {
        const errorData = await response.json();
        
        // Handle email verification required error
        if (errorData.requiresVerification) {
          toast({
            title: "Email Verification Required",
            description: errorData.message || "Please verify your email address before logging in.",
            variant: "destructive",
          });
          setIsLoading(false);
          return;
        }
        
        throw new Error(errorData.message || 'Authentication failed');
      }
    } catch (error) {
      toast({
        title: "Error",
        description: error instanceof Error ? error.message : "Authentication failed",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  // Handle voice biometric login
  const handleVoiceBiometricLogin = async (voiceData: string, transcribedText?: string) => {
    console.log('handleVoiceBiometricLogin called with voiceData length:', voiceData?.length);
    console.log('Transcribed text:', transcribedText);
    console.log('Current formData.username:', formData.username);
    
    // Get username from input field directly if form state is empty
    const usernameInput = document.getElementById('username') as HTMLInputElement;
    const username = formData.username.trim() || usernameInput?.value?.trim() || '';
    
    console.log('Final username to use:', username);
    
    if (!username) {
      console.log('Username validation failed - field is empty');
      toast({
        title: "Username Required",
        description: "Please enter your username first",
        variant: "destructive",
      });
      return;
    }

    setIsLoading(true);
    console.log('Attempting voice biometric login for:', username);

    try {
      const response = await apiRequest('POST', '/api/voice-biometric-login', {
        username: username,
        voiceData: voiceData,
        transcribedText: transcribedText
      });

      if (response.ok) {
        const userData = await response.json();
        console.log('Voice biometric login successful:', userData);
        
        // Store session token if provided
        if (userData.sessionId) {
          localStorage.setItem('sessionId', userData.sessionId);
        }
        
        toast({
          title: "Voice Authentication Successful",
          description: "Welcome back!",
        });
        
        // Force navigation to home page
        setTimeout(() => {
          safeRedirect('/');
        }, 500);
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.log('Voice biometric login failed:', errorData);
        console.log('Error message received:', errorData.message);
        
        // If voice authentication is not set up, offer to set it up
        if (errorData.message === "Voice authentication not set up") {
          console.log('Voice not set up, triggering auto-setup...');
          setIsLoading(false); // Reset loading state
          toast({
            title: "Voice Setup Required",
            description: "Setting up voice authentication for your account...",
          });
          await handleVoiceBiometricSetup(voiceData);
          return;
        }
        
        throw new Error(errorData.message || 'Voice authentication failed');
      }
    } catch (error: any) {
      console.error('Voice biometric login error:', error);
      
      // Check if this is a 401 error for voice setup
      if (error.message && error.message.includes("Voice authentication not set up")) {
        console.log('Caught voice setup error, triggering auto-setup...');
        setIsLoading(false);
        toast({
          title: "Voice Setup Required",
          description: "Setting up voice authentication for your account...",
        });
        await handleVoiceBiometricSetup(voiceData);
        return;
      }
      
      toast({
        title: "Voice Authentication Failed",
        description: error instanceof Error ? error.message : "Voice not recognized. Please try again.",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  // Handle voice biometric setup
  const handleVoiceBiometricSetup = async (voiceData: string) => {
    // Get username from input field directly if form state is empty
    const usernameInput = document.getElementById('username') as HTMLInputElement;
    const username = formData.username.trim() || usernameInput?.value?.trim() || '';
    
    console.log('Setting up voice biometric for username:', username);
    console.log('Voice data length for setup:', voiceData?.length);
    
    try {
      const response = await apiRequest('POST', '/api/voice-biometric-setup', {
        username: username,
        voiceData: voiceData
      });

      if (response.ok) {
        toast({
          title: "Voice Authentication Setup Complete",
          description: "You can now log in with your voice",
        });
        // Automatically attempt login after setup
        await handleVoiceBiometricLogin(voiceData);
      } else {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || 'Voice setup failed');
      }
    } catch (error) {
      console.error('Voice biometric setup error:', error);
      toast({
        title: "Voice Setup Failed",
        description: error instanceof Error ? error.message : "Could not set up voice authentication",
        variant: "destructive",
      });
    }
  };

  // Handle voice password setup during registration
  const handleVoicePasswordSetup = (voicePassword: string) => {
    setFormData(prev => ({ ...prev, voicePassword }));
    setVoiceAuthEnabled(true);
    toast({
      title: "Voice Password Set",
      description: "Your voice password has been recorded successfully.",
    });
  };

  // Handle voice training completion
  const handleVoiceTrainingComplete = (voiceData: any) => {
    setFormData(prev => ({ 
      ...prev, 
      voicePassword: "welcome to the best ai list",
      voiceTrainingData: JSON.stringify(voiceData)
    }));
    setVoiceAuthEnabled(true);
    setShowVoiceTraining(false);
    toast({
      title: "Voice Training Complete",
      description: "Your voice has been trained successfully!",
    });
  };

  return (
    <div className="auth-container min-h-screen bg-gradient-to-br from-gray-900 to-gray-800 flex items-center justify-center p-4">
      <div className="w-full max-w-6xl grid lg:grid-cols-2 gap-8">
        
        {/* Hero Section */}
        <motion.div 
          initial={{ opacity: 0, x: -50 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.6 }}
          className="flex flex-col justify-center space-y-6 text-center lg:text-left"
        >
          <div>
            <h1 className="text-4xl lg:text-6xl font-bold text-white">
              AICHECKLIST
            </h1>
            <p className="text-xl text-gray-300 mt-4">
              Intelligent task management with voice-powered authentication
            </p>
          </div>
          
          <div className="space-y-4">
            <div className="flex items-center gap-3">
              <div className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                <Mic className="h-4 w-4 text-primary" />
              </div>
              <span className="text-white">Voice commands for tasks (coming soon: voice login)</span>
            </div>
            <div className="flex items-center gap-3">
              <div className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                <User className="h-4 w-4 text-primary" />
              </div>
              <span className="text-white">AI-powered task suggestions</span>
            </div>
            <div className="flex items-center gap-3">
              <div className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                <Lock className="h-4 w-4 text-primary" />
              </div>
              <span className="text-white">Secure cloud synchronization</span>
            </div>
            
            {/* Video Introduction Button */}
            <div className="flex items-center gap-3 mt-4">
              <button
                onClick={() => setShowVideoPopup(true)}
                className="relative text-green-600 hover:text-green-700 underline hover:no-underline transition-all duration-200 text-left overflow-hidden light-wave-text"
              >
                Here is why to use AI Checklist
              </button>
            </div>
            
            {/* Video Demo Button */}
            <div className="flex justify-center lg:justify-start mt-6">
              <Button
                onClick={() => setShowVideoPopup(true)}
                variant="outline"
                className="group flex items-center gap-2 border-primary/50 hover:border-primary hover:bg-primary/10"
              >
                <Play className="h-4 w-4 text-primary group-hover:animate-pulse" />
                Watch Demo Video
              </Button>
            </div>
            
            {/* Download Counter - Under the video button */}
            <div className="flex justify-center lg:justify-start mt-4">
              <React.Suspense fallback={<div className="text-sm text-muted-foreground">Loading stats...</div>}>
                <DownloadCounter />
              </React.Suspense>
            </div>
          </div>
        </motion.div>

        {/* Auth Form Section */}
        <motion.div
          initial={{ opacity: 0, x: 50 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.6, delay: 0.2 }}
        >
          <Card className="w-full max-w-md mx-auto">
            <CardHeader className="text-center">
              <CardTitle className="text-2xl">
                {authMode === 'login' ? 'Welcome Back' : 'Create Account'}
              </CardTitle>
              <CardDescription>
                {authMode === 'login' 
                  ? 'Sign in to your account'
                  : 'Create a new account'
                }
              </CardDescription>
            </CardHeader>

            <CardContent>
              <Tabs value={authMode} onValueChange={(value) => setAuthMode(value as 'login' | 'register')}>
                <TabsList className="grid w-full grid-cols-2">
                  <TabsTrigger value="login">Login</TabsTrigger>
                  <TabsTrigger value="register">Register</TabsTrigger>
                </TabsList>

                <TabsContent value="login" className="space-y-4">
                  {/* Choose between email code or username/password login */}
                  {useEmailCode ? (
                    <motion.div
                      key="email-code-login"
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="space-y-4"
                    >
                      <div className="text-center space-y-2">
                        <h3 className="text-lg font-semibold">Sign in with Email</h3>
                        <p className="text-sm text-muted-foreground">
                          No password needed - we'll send you a login code
                        </p>
                      </div>
                      
                      {emailCodeStep === 'email' ? (
                        <>
                          <div className="space-y-2">
                            <Label htmlFor="email-login">Email Address</Label>
                            <Input
                              id="email-login"
                              type="email"
                              value={formData.email}
                              onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                              placeholder="your.email@example.com"
                              required
                            />
                          </div>
                          
                          <Button 
                            onClick={handleSendEmailCode} 
                            className="w-full" 
                            disabled={isLoading}
                            type="button"
                          >
                            {isLoading ? 'Sending Code...' : 'Send Login Code'}
                          </Button>
                        </>
                      ) : (
                        <>
                          <div className="space-y-2">
                            <Label htmlFor="code">Enter Code</Label>
                            <p className="text-sm text-muted-foreground">
                              We sent a 6-digit code to {formData.email}
                            </p>
                            <Input
                              id="code"
                              type="text"
                              value={verificationCode}
                              onChange={(e) => setVerificationCode(e.target.value)}
                              placeholder="Enter 6-digit code"
                              maxLength={6}
                              className="text-center text-2xl tracking-widest font-mono"
                              required
                            />
                          </div>
                          
                          <Button 
                            onClick={handleVerifyCode} 
                            className="w-full" 
                            disabled={isLoading}
                            type="button"
                          >
                            {isLoading ? 'Verifying...' : 'Sign In'}
                          </Button>
                          
                          <button
                            type="button"
                            onClick={() => {
                              setEmailCodeStep('email');
                              setVerificationCode('');
                            }}
                            className="text-sm text-muted-foreground hover:text-primary underline w-full text-center"
                          >
                            Use a different email
                          </button>
                        </>
                      )}
                      
                      <Separator />
                      
                      <button
                        type="button"
                        onClick={() => {
                          setUseEmailCode(false);
                          setEmailCodeStep('email');
                          setVerificationCode('');
                        }}
                        className="text-sm text-muted-foreground hover:text-primary underline w-full text-center"
                      >
                        Sign in with username & password instead
                      </button>
                    </motion.div>
                  ) : (
                    <motion.form
                      key="traditional-login"
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      onSubmit={handleTraditionalAuth}
                      className="space-y-4"
                    >
                    <div className="space-y-2">
                      <Label htmlFor="username">Username</Label>
                      <Input
                        id="username"
                        type="text"
                        value={formData.username}
                        onChange={(e) => setFormData(prev => ({ ...prev, username: e.target.value }))}
                        placeholder="Enter your username"
                        required
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="password">Password</Label>
                      <div className="relative">
                        <Input
                          id="password"
                          type={showPassword ? 'text' : 'password'}
                          value={formData.password}
                          onChange={(e) => setFormData(prev => ({ ...prev, password: e.target.value }))}
                          required
                        />
                        <Button
                          type="button"
                          variant="ghost"
                          size="icon"
                          className="absolute right-0 top-0 h-full px-3"
                          onClick={() => setShowPassword(!showPassword)}
                        >
                          {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </Button>
                      </div>
                    </div>

                    <Button type="submit" className="w-full" disabled={isLoading}>
                      {isLoading ? 'Signing In...' : 'Sign In'}
                    </Button>
                    
                    <div className="text-center mt-4">
                      <button
                        type="button"
                        onClick={() => setLocation('/forgot-password')}
                        className="text-sm text-muted-foreground hover:text-primary underline"
                      >
                        Forgot Password?
                      </button>
                    </div>
                    
                    <Separator />
                    
                    <button
                      type="button"
                      onClick={() => {
                        setUseEmailCode(true);
                        setEmailCodeStep('email');
                      }}
                      className="text-sm text-muted-foreground hover:text-primary underline w-full text-center"
                    >
                      Sign in with email code instead (no password needed)
                    </button>
                  </motion.form>
                  )}
                </TabsContent>

                <TabsContent value="register" className="space-y-4">
                  <form onSubmit={handleTraditionalAuth} className="space-y-4">
                    <div className="space-y-2">
                      <Label htmlFor="reg-username">Username *</Label>
                      <Input
                        id="reg-username"
                        type="text"
                        value={formData.username}
                        onChange={(e) => setFormData(prev => ({ ...prev, username: e.target.value }))}
                        placeholder="Choose a username"
                        required
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="reg-email">Email Address *</Label>
                      <Input
                        id="reg-email"
                        type="email"
                        value={formData.email}
                        onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                        placeholder="your.email@example.com"
                        required
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="reg-password">Password</Label>
                      <div className="relative">
                        <Input
                          id="reg-password"
                          type={showPassword ? 'text' : 'password'}
                          value={formData.password}
                          onChange={(e) => setFormData(prev => ({ ...prev, password: e.target.value }))}
                          required
                        />
                        <Button
                          type="button"
                          variant="ghost"
                          size="icon"
                          className="absolute right-0 top-0 h-full px-3"
                          onClick={() => setShowPassword(!showPassword)}
                        >
                          {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </Button>
                      </div>
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="reg-confirm-password">Confirm Password</Label>
                      <div className="relative">
                        <Input
                          id="reg-confirm-password"
                          type={showPassword ? 'text' : 'password'}
                          value={formData.confirmPassword}
                          onChange={(e) => setFormData(prev => ({ ...prev, confirmPassword: e.target.value }))}
                          required
                          className={formData.password && formData.confirmPassword && formData.password !== formData.confirmPassword ? 'border-red-500' : ''}
                        />
                        <Button
                          type="button"
                          variant="ghost"
                          size="icon"
                          className="absolute right-0 top-0 h-full px-3"
                          onClick={() => setShowPassword(!showPassword)}
                        >
                          {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </Button>
                      </div>
                      {formData.password && formData.confirmPassword && formData.password !== formData.confirmPassword && (
                        <p className="text-sm text-red-500">
                          Passwords do not match
                        </p>
                      )}
                    </div>


                    {/* Terms of Service Agreement */}
                    <div className="space-y-3 p-4 border rounded-lg bg-blue-50 border-blue-200">
                      <div className="flex items-start space-x-3">
                        <Checkbox
                          id="terms-checkbox"
                          checked={termsAccepted}
                          onCheckedChange={(checked) => setTermsAccepted(checked as boolean)}
                          data-testid="terms-checkbox"
                          className="mt-0.5"
                        />
                        <div className="space-y-2">
                          <Label htmlFor="terms-checkbox" className="text-sm font-medium leading-5">
                            I accept the{' '}
                            <button
                              type="button"
                              onClick={() => setShowTerms(true)}
                              className="text-blue-600 hover:text-blue-800 underline"
                            >
                              Terms of Service and License Agreement
                            </button>
                          </Label>
                          <p className="text-xs text-blue-700">
                            Required: Includes competitive use restrictions
                          </p>
                        </div>
                      </div>
                    </div>

                    <Separator />

                    <div className="space-y-4">
                      <div className="flex items-center justify-between">
                        <Label>Voice Password (Optional)</Label>
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          onClick={() => setVoiceAuthEnabled(!voiceAuthEnabled)}
                        >
                          {voiceAuthEnabled ? 'Disable' : 'Enable'}
                        </Button>
                      </div>

                      {voiceAuthEnabled && !showVoiceTraining && (
                        <motion.div
                          initial={{ opacity: 0, height: 0 }}
                          animate={{ opacity: 1, height: 'auto' }}
                          exit={{ opacity: 0, height: 0 }}
                          className="space-y-4"
                        >
                          <div className="text-center">
                            <p className="text-sm text-muted-foreground mb-4">
                              Train the system to recognize your unique voice for secure authentication
                            </p>
                            <Button
                              type="button"
                              onClick={() => setShowVoiceTraining(true)}
                              className="bg-primary hover:bg-primary/90"
                            >
                              Start Voice Training
                            </Button>
                          </div>
                        </motion.div>
                      )}

                      {showVoiceTraining && (
                        <motion.div
                          initial={{ opacity: 0, height: 0 }}
                          animate={{ opacity: 1, height: 'auto' }}
                          exit={{ opacity: 0, height: 0 }}
                        >
                          <VoiceTraining
                            phrase="welcome to the best ai list"
                            onTrainingComplete={handleVoiceTrainingComplete}
                            onCancel={() => setShowVoiceTraining(false)}
                          />
                        </motion.div>
                      )}
                    </div>

                    <Button type="submit" className="w-full" disabled={isLoading}>
                      {isLoading ? 'Creating Account...' : 'Create Account'}
                    </Button>
                  </form>
                </TabsContent>
              </Tabs>
            </CardContent>
          </Card>
        </motion.div>
      </div>
      
      {/* Footer */}
      <div className="absolute bottom-4 left-0 right-0 text-center">
        <p className="text-sm text-muted-foreground">
          eagletechsoftware inc
        </p>
      </div>
      
      {/* Terms of Service Modal */}
      <TermsOfService
        isOpen={showTerms}
        onClose={() => setShowTerms(false)}
        onAccept={() => {
          setTermsAccepted(true);
          setShowTerms(false);
          toast({
            title: "Terms Accepted",
            description: "Thank you for accepting our Terms of Service",
            variant: "default",
          });
        }}
      />

      {/* Video Popup - Only load when opened */}
      {showVideoPopup && (
        <React.Suspense fallback={<div className="fixed inset-0 bg-black/50 flex items-center justify-center text-white">Loading video...</div>}>
          <VideoPopup
            isOpen={showVideoPopup}
            onClose={() => setShowVideoPopup(false)}
            videoUrl={videoUrl}
            title="Why AI Checklist?"
          />
        </React.Suspense>
      )}
    </div>
  );
}